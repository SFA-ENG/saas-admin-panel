import { useEffect, useState } from "react";
import { matchPath, Outlet, useNavigate } from "react-router-dom";
import Custom401 from "../401/401";
import jwt_decode from "jwt-decode";
import Header from "../Header/Header";
import _ from "lodash";
import "./MainLayout.css";
 
import { Drawer } from "antd";
import { withAuthContext } from "../../contexts/AuthContext/AuthContext";
import Navigation from "Components/Navigation/Navigation";
import { generatePermissionToURLMapping } from "routing.helpers";
import { HEADER_TITLES, sideMenuConfig } from "routing";
import { userAccessTypes } from "pages/UserAdministrationPage/UserPage.helper";
 
const getPermissions = ({ pathname, permissions }) => {
  const urlToPermisison = generatePermissionToURLMapping({
    sideMenuConfig: sideMenuConfig,
  });
 
  const ROUTING_PATTRNS = Object.keys(HEADER_TITLES.headerTitles);
  for (let i = 0; i < ROUTING_PATTRNS.length; i++) {
    const element = ROUTING_PATTRNS[i];
    const match = matchPath(element, pathname);
    if (!_.isEmpty(match)) {
      const requiredPermission = urlToPermisison[match.pattern.path];
      const hasAccess = _.intersection(requiredPermission, permissions);
 
      // const editFlag = hasAccess.some((item) => {
      //   return item.startsWith("UPDATE");
      // });
 
      return {
        authzFlag: Boolean(hasAccess.length),
        // editFlag,
      };
    }
  }
  return {
    authzFlag: false,
    // editFlag: false,
  };
};
 
const MainLayoutWithoutContext = ({ authContext }) => {
  const pathname = window.location.pathname;
  const [collapsed, setCollapsed] = useState(false);
  const [isTokenVerified, setTokenVerified] = useState(false);
  const [isAuthorized, setAuthorized] = useState(false);
  const [loading, setLoading] = useState(true);
  const { setUserMasterData, userData } = authContext;
 
  const navigate = useNavigate();
 
  useEffect(() => {
    const token = localStorage.getItem("token");
    const userData = JSON.parse(localStorage.getItem("user_data"));
    if (!token || !userData?.email) {
      navigate("/login");
      return;
    }
    const decoded = jwt_decode(token);
    const currentTime = Math.floor(Date.now() / 1000);
    if (currentTime < decoded.exp && decoded.email === userData.email) {
      setTokenVerified(true);
      setUserMasterData({ user_data: userData });
    } else {
      navigate("/login");
    }
    setLoading(null);
    //eslint-disable-next-line
  }, []);
 
  useEffect(() => {
    if (loading) return;
    setAuthorized(false);
    setLoading(true);
    function controlAcessAndEdit() {
      setLoading(true);
      if (userData?.access_type === userAccessTypes.SUPER_ADMIN) {
        setAuthorized(true);
      } else if (userData?.access_type === userAccessTypes.ADMIN) {
        if (pathname !== "/user-administration/roles-permission") {
          setAuthorized(true);
        }
      } else {
        const { authzFlag } = getPermissions({
          permissions: userData.permissions,
          pathname,
        });
        setAuthorized(authzFlag);
      }
      setLoading(null);
    }
 
    controlAcessAndEdit();
  }, [pathname, userData, loading]);
 
  const handleMenuClick = () => {
    setCollapsed(true);
  };
 
  if (loading === true) return null;
 
  if (isTokenVerified && !loading) {
    return (
      <section className="MainLayout">
        <Header handleMenuClick={handleMenuClick} />
        <main>
          <div className="mobile-only">
            <Drawer
              placement="left"
              onClose={() => setCollapsed(false)}
              open={collapsed}
              width={100}
              className="main-navigation-drawer"
            >
              <Navigation closeMenu={() => setCollapsed(false)} />
            </Drawer>
          </div>
          <div className="desktop-only">
            <aside>
              <Navigation closeMenu={() => setCollapsed(false)} />
            </aside>
          </div>
          <div className="main-content">
            {isTokenVerified && isAuthorized ? <Outlet /> : <Custom401 />}
          </div>
        </main>
      </section>
    );
  }
 
  return null;
};
 
const MainLayout = withAuthContext(MainLayoutWithoutContext);
 
export default MainLayout;
 